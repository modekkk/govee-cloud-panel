
<!doctype html>
<html lang="pl">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Govee – Panel (Cloud API) v4.9</title>
<style>
  :root{ --accent:#2563eb; --bg:#fafafa; --muted:#666; }
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;max-width:1280px;background:#fff}
  h1{margin:8px 0 16px}
  .row{display:flex;gap:12px;align-items:center;margin:10px 0;flex-wrap:wrap}
  fieldset{border:1px solid #e5e5e5;padding:14px;border-radius:12px;margin-bottom:16px;background:#fff}
  legend{padding:0 6px;color:#555}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;cursor:pointer;background:#fff}
  button.primary{background:var(--accent);color:white;border-color:var(--accent)}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  @media (max-width: 1024px){ .grid3{grid-template-columns:1fr} .grid{grid-template-columns:1fr} }
  pre{background:#f6f6f6;border:1px solid #e5e5e5;padding:10px;border-radius:8px;max-height:260px;overflow:auto}
  input[type=text],input[type=number]{width:100%;padding:6px;border:1px solid #ddd;border-radius:8px}
  input[type=range]{width:260px}
  .card{border:1px solid #eee;border-radius:12px;padding:12px;background:#fff}
  .small{font-size:12px}
  .tools{display:flex;gap:10px;flex-wrap:wrap}
  .canvasWrap{position:relative}
  svg.map{width:100%;height:520px;border:1px dashed #ccc;border-radius:12px;background:var(--bg)}
  .dot{cursor:grab}
  .dot:active{cursor:grabbing}
  .mini{position:absolute;display:none;min-width:220px;background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,.1);padding:10px;z-index:10}
  .mini .row{margin:6px 0}
  .bgPreview{max-width:320px;max-height:180px;border:1px solid #ddd;border-radius:8px}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid #ddd;font-size:12px}
</style>
<body>
  <div class="row" style="justify-content:space-between">
    <h1>Govee – Panel (Cloud API) <small>v4.9</small></h1>
    <form id="logoutF"><button>Wyloguj</button></form>
  </div>
  <p class="muted">Hasłowane logowanie (<b>admin / werusia321</b> – możesz zmienić ENV), auto-refresh stanu i kolory kropek, edycja pokoi/ścian, grupy, pełny eksport/import projektu.</p>

  <fieldset class="card">
    <legend>Menadżer urządzeń</legend>
    <div class="grid3">
      <div><label>Nazwa</label><input id="label" placeholder="np. Żarówka - telewizor"/></div>
      <div><label>Device</label><input id="device" placeholder="np. 6F:F6:..."/></div>
      <div><label>SKU</label><input id="sku" placeholder="np. H6004"/></div>
    </div>
    <div class="tools">
      <button id="save" class="primary">Zapisz/aktualizuj</button>
      <button id="saveQuick">Zapisz jako „Żarówka - telewizor”</button>
      <button id="delete">Usuń</button>
      <button id="exportDevices">Eksport urządzeń</button>
      <input type="file" id="importDevices" accept="application/json"/>
    </div>
    <div class="row">
      <label>Lista</label>
      <select id="savedList"><option value="">— wybierz zapisane urządzenie —</option></select>
      <button id="select">Użyj</button>
      <span id="stateBadge" class="pill muted">auto-refresh: off</span>
      <button id="toggleAuto">Auto-refresh ON/OFF</button>
    </div>
    <details>
      <summary>Pozycja / meta</summary>
      <div class="grid3">
        <div><label>Pokój</label><input id="room" placeholder="np. salon"/></div>
        <div><label>Pozycja X,Y (0..1)</label><input id="posxy" placeholder="np. 0.50,0.25"/></div>
        <div><label>Z (wysokość)</label><input id="posz" placeholder="np. 2.4"/></div>
      </div>
    </details>
  </fieldset>

  <fieldset class="card">
    <legend>Grupy</legend>
    <div class="tools">
      <input id="groupName" placeholder="np. Salon"/>
      <button id="groupAdd">Dodaj grupę</button>
      <select id="groupList"><option value="">— wybierz grupę —</option></select>
      <button id="groupDel">Usuń grupę</button>
    </div>
    <div class="tools">
      <button id="groupAttach">Dodaj WYBRANE urządzenie do grupy</button>
      <button id="groupOn">Grupa: ON</button>
      <button id="groupOff">Grupa: OFF</button>
      <input type="range" id="groupBri" min="1" max="100" value="50"/><span id="groupBVal">50%</span>
      <button id="groupSetBri">Ustaw jasność</button>
      <input type="color" id="groupColor" value="#ffffff"/><button id="groupSetColor">Ustaw kolor</button>
    </div>
  </fieldset>

  <fieldset class="card">
    <legend>Plan mieszkania</legend>
    <div class="tools">
      <input type="file" id="bgFile" accept="image/*"/>
      <button id="clearBg">Usuń tło</button>
      <img id="bgPreview" class="bgPreview" alt="Podgląd tła"/>
      <button id="exportProject">Eksport projektu</button>
      <input type="file" id="importProject" accept="application/json"/>
    </div>
    <div class="tools">
      <button id="addRoom">Dodaj pokój</button>
      <button id="addWall">Dodaj ścianę</button>
      <label><input type="checkbox" id="snap"/> Snap do siatki</label>
      <button id="clearPlan">Wyczyść plan</button>
    </div>
    <div class="canvasWrap">
      <svg class="map" id="map" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet">
        <defs>
          <pattern id="bgPattern" patternUnits="userSpaceOnUse" width="1000" height="600">
            <image id="bgImage" href="" x="0" y="0" width="1000" height="600" preserveAspectRatio="xMidYMid slice" />
          </pattern>
        </defs>
        <rect id="bgRect" x="0" y="0" width="1000" height="600" fill="url(#bgPattern)"></rect>
        <g id="rooms"></g>
        <g id="walls" stroke="#333" stroke-width="4" stroke-linecap="round"></g>
        <g id="dots"></g>
      </svg>
      <div id="mini" class="mini">
        <div class="row"><b id="miniLabel">—</b></div>
        <div class="row"><input type="range" id="miniBri" min="1" max="100"/><span id="miniBriVal" class="muted small"></span></div>
        <div class="row"><input type="color" id="miniColor"/><button id="miniSetColor">Kolor</button></div>
        <div class="row">
          <input type="number" id="miniK" value="3000" min="2700" max="6500" step="50" style="width:110px"/><button id="miniSetK">CCT</button>
        </div>
        <div class="row"><button id="miniOn">On</button><button id="miniOff">Off</button></div>
        <div class="row"><button id="miniClose">Zamknij</button></div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Log</legend>
    <pre id="raw"></pre>
  </fieldset>

<script>
// ===== logout =====
document.getElementById("logoutF").onsubmit = async (e)=>{
  e.preventDefault();
  await fetch("/api/logout",{method:"POST"});
  location.href = "/login.html";
};

// ===== storage =====
const DEVKEY = "govee.devices";           // [{id,label,device,sku,meta:{room,x,y,z}, state:{...}}]
const PLANKEY = "govee.plan";             // {bg, rooms:[{id,x,y,w,h,label,color}], walls:[{id,x1,y1,x2,y2}]}
const GROUPKEY = "govee.groups";          // [{id,name,deviceIds:[]}]

const api = (p, opt)=>fetch(p, opt).then(r=>r.json());
const qs = (s)=>document.querySelector(s);
const show = (el, obj)=> el.textContent = JSON.stringify(obj, null, 2);
const uuid = ()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const clamp01 = v=>Math.max(0,Math.min(1,v));

function loadDevices(){ try { return JSON.parse(localStorage.getItem(DEVKEY) || "[]"); } catch { return []; } }
function saveDevices(list){ localStorage.setItem(DEVKEY, JSON.stringify(list)); }
function loadPlan(){ try { return JSON.parse(localStorage.getItem(PLANKEY) || '{"rooms":[],"walls":[]}' ); } catch{ return {rooms:[],walls:[]} } }
function savePlan(plan){ localStorage.setItem(PLANKEY, JSON.stringify(plan)); }
function loadGroups(){ try { return JSON.parse(localStorage.getItem(GROUPKEY) || "[]"); } catch{ return []; } }
function saveGroups(gs){ localStorage.setItem(GROUPKEY, JSON.stringify(gs)); }

// ===== UI: devices =====
function formToObj(){
  const norm = v => { const n = parseFloat(v); return Number.isFinite(n) ? n : undefined; };
  const [x,y] = (qs("#posxy").value||"").split(",").map(s=>norm(s.trim()));
  return {
    label: qs("#label").value.trim(),
    device: qs("#device").value.trim(),
    sku: qs("#sku").value.trim(),
    meta: { room: qs("#room").value.trim() || undefined, x, y, z: norm(qs("#posz").value) }
  };
}
function objToForm(o){
  qs("#label").value = o.label || "";
  qs("#device").value = o.device || "";
  qs("#sku").value = o.sku || "";
  qs("#room").value = o.meta?.room || "";
  const xy = [o.meta?.x, o.meta?.y].every(n=>typeof n === "number") ? `${o.meta.x},${o.meta.y}` : "";
  qs("#posxy").value = xy;
  qs("#posz").value = typeof o.meta?.z === "number" ? o.meta.z : "";
}
function refreshSavedList(selectedId){
  const list = loadDevices();
  const sel = qs("#savedList");
  sel.innerHTML = '<option value="">— wybierz zapisane urządzenie —</option>';
  list.forEach(it=>{
    const opt = document.createElement("option");
    opt.value = it.id;
    let label = it.label || it.sku || "Urządzenie";
    if(it.meta?.room) label = `[${it.meta.room}] ` + label;
    opt.textContent = `${label} (${it.device} | ${it.sku})`;
    sel.appendChild(opt);
  });
  if (selectedId) sel.value = selectedId;
  renderPlan();
  return list;
}
function upsertCurrent(asLabel){
  const form = formToObj();
  if (asLabel) form.label = asLabel;
  if (!form.device || !form.sku) { alert("Podaj device i sku"); return; }
  const list = loadDevices();
  const idx = list.findIndex(it=>it.device===form.device && it.sku===form.sku);
  if (idx>=0){ list[idx] = { ...list[idx], ...form }; }
  else { list.push({ id: uuid(), ...form }); }
  saveDevices(list);
  refreshSavedList();
  alert("Zapisano.");
}
qs("#save").onclick = ()=> upsertCurrent();
qs("#saveQuick").onclick = ()=> upsertCurrent("Żarówka - telewizor");
qs("#delete").onclick = ()=>{
  const list = loadDevices();
  const selId = qs("#savedList").value;
  if (!selId) { alert("Wybierz pozycję z listy"); return; }
  const idx = list.findIndex(it=>it.id===selId);
  if (idx>=0){ list.splice(idx,1); saveDevices(list); refreshSavedList(); alert("Usunięto."); }
};
qs("#savedList").onchange = (e)=>{
  const list = loadDevices();
  const it = list.find(x=>x.id===e.target.value);
  if (it) objToForm(it);
};
qs("#select").onclick = ()=>{
  const selId = qs("#savedList").value;
  const list = loadDevices();
  const it = list.find(x=>x.id===selId);
  if (!it){ alert("Wybierz pozycję z listy"); return; }
  objToForm(it);
  alert("Załadowano wybraną żarówkę do formularza.");
};
// Export/import devices
qs("#exportDevices").onclick = ()=>{
  const data = JSON.stringify(loadDevices(), null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "govee-devices.json"; a.click();
  URL.revokeObjectURL(url);
};
qs("#importDevices").onchange = (e)=>{
  const file = e.target.files?.[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{ try{ const arr = JSON.parse(String(reader.result||"[]")); if (!Array.isArray(arr)) throw new Error("Błędny format"); saveDevices(arr); refreshSavedList(); alert("Zaimportowano."); }catch(err){ alert("Błąd importu: "+err.message); } };
  reader.readAsText(file);
};

// ===== Groups =====
function refreshGroups(selectedId){
  const gs = loadGroups();
  const sel = qs("#groupList");
  sel.innerHTML = '<option value="">— wybierz grupę —</option>';
  gs.forEach(g=>{
    const o = document.createElement("option"); o.value = g.id; o.textContent = `${g.name} (${g.deviceIds?.length||0})`; sel.appendChild(o);
  });
  if (selectedId) sel.value = selectedId;
}
qs("#groupAdd").onclick = ()=>{
  const name = qs("#groupName").value.trim(); if (!name) return alert("Podaj nazwę grupy");
  const gs = loadGroups(); gs.push({ id: uuid(), name, deviceIds: [] }); saveGroups(gs); refreshGroups();
  qs("#groupName").value = "";
};
qs("#groupDel").onclick = ()=>{
  const id = qs("#groupList").value; if (!id) return alert("Wybierz grupę");
  const gs = loadGroups(); const i = gs.findIndex(g=>g.id===id); if (i>=0){ gs.splice(i,1); saveGroups(gs); refreshGroups(); alert("Usunięto."); }
};
qs("#groupAttach").onclick = ()=>{
  const gid = qs("#groupList").value; if (!gid) return alert("Wybierz grupę");
  const selId = qs("#savedList").value; if (!selId) return alert("Wybierz urządzenie z listy");
  const gs = loadGroups(); const g = gs.find(x=>x.id===gid); if (!g) return;
  const dev = loadDevices().find(x=>x.id===selId); if (!dev) return;
  g.deviceIds = g.deviceIds || []; if (!g.deviceIds.includes(dev.id)) g.deviceIds.push(dev.id);
  saveGroups(gs); refreshGroups(gid); alert("Dodano do grupy.");
};
qs("#groupBri").oninput = e => qs("#groupBVal").textContent = e.target.value + "%";
qs("#groupOn").onclick = async ()=>{ await groupCommand(async (d)=> api("/api/power",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({ device:d.device, sku:d.sku, on:true })})); };
qs("#groupOff").onclick = async ()=>{ await groupCommand(async (d)=> api("/api/power",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({ device:d.device, sku:d.sku, on:false })})); };
qs("#groupSetBri").onclick = async ()=>{ const v = Number(qs("#groupBri").value); await groupCommand(async (d)=> api("/api/brightness",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({ device:d.device, sku:d.sku, value:v })})); };
qs("#groupSetColor").onclick = async ()=>{
  const hex = qs("#groupColor").value.replace("#",""); const r = parseInt(hex.slice(0,2),16), g = parseInt(hex.slice(2,4),16), b = parseInt(hex.slice(4,6),16);
  await groupCommand(async (d)=> api("/api/color",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({ device:d.device, sku:d.sku, r, g, b })}));
};
async function groupCommand(fn){
  const id = qs("#groupList").value; if (!id) return alert("Wybierz grupę");
  const gs = loadGroups(); const g = gs.find(x=>x.id===id); if (!g) return;
  const devices = loadDevices().filter(d=>g.deviceIds?.includes(d.id));
  for (const d of devices){ try{ const r = await fn(d); console.log("group cmd", d.label, r?.code); }catch{} }
  alert("Wysłano komendy do grupy.");
}

// ===== Plan builder (rooms/walls) with editing & snap =====
const map = qs("#map"); const gRooms = document.getElementById("rooms"); const gWalls = document.getElementById("walls"); const gDots = document.getElementById("dots");
const bgImage = document.getElementById("bgImage"); const bgPreview = document.getElementById("bgPreview");

function gridSnap(v, step){ return Math.round(v/step)*step; } // v in 0..1

function renderPlan(){
  const plan = loadPlan(); const devs = loadDevices();
  // background
  if (plan.bg){ bgImage.setAttribute("href", plan.bg); bgPreview.src = plan.bg; } else { bgImage.removeAttribute("href"); bgPreview.removeAttribute("src"); }
  // rooms
  gRooms.innerHTML = "";
  (plan.rooms||[]).forEach(r=>{
    const el = document.createElementNS("http://www.w3.org/2000/svg","rect");
    el.setAttribute("x", r.x*1000); el.setAttribute("y", r.y*600); el.setAttribute("width", r.w*1000); el.setAttribute("height", r.h*600);
    el.setAttribute("fill", r.color || "#f0f7ff"); el.setAttribute("stroke","#bcd7ff"); el.setAttribute("stroke-width","2");
    gRooms.appendChild(el);
    // label
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x", r.x*1000 + 6); t.setAttribute("y", r.y*600 + 16); t.setAttribute("font-size","12"); t.textContent = r.label || "Pokój";
    t.setAttribute("fill","#444"); gRooms.appendChild(t);
    // click -> edit
    el.addEventListener("click",(e)=>{
      e.preventDefault();
      const name = prompt("Nazwa pokoju:", r.label || "Pokój");
      if (name===null) return;
      r.label = name;
      const color = prompt("Kolor w hex (np. #f0f7ff):", r.color || "#f0f7ff");
      if (color!==null) r.color = color;
      savePlan(plan); renderPlan();
    });
    // right-click -> delete
    el.addEventListener("contextmenu",(e)=>{
      e.preventDefault();
      if (confirm("Usunąć ten pokój?")){ plan.rooms = plan.rooms.filter(x=>x!==r); savePlan(plan); renderPlan(); }
    });
    // drag move
    let dragging=false, sx=0, sy=0, start={x:r.x,y:r.y};
    el.addEventListener("mousedown",(e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; start={x:r.x,y:r.y}; e.preventDefault(); });
    window.addEventListener("mousemove",(e)=>{
      if(!dragging) return;
      const rect=map.getBoundingClientRect();
      let dx=(e.clientX-sx)/rect.width, dy=(e.clientY-sy)/rect.height;
      let nx = clamp01(start.x+dx), ny = clamp01(start.y+dy);
      if (qs("#snap").checked){ nx = gridSnap(nx, 0.02); ny = gridSnap(ny, 0.02); }
      r.x = Math.max(0, Math.min(1-r.w, nx));
      r.y = Math.max(0, Math.min(1-r.h, ny));
      savePlan(plan); renderPlan();
    });
    window.addEventListener("mouseup",()=> dragging=false);
  });
  // walls (with draggable endpoints)
  gWalls.innerHTML = "";
  (plan.walls||[]).forEach(w=>{
    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", w.x1*1000); line.setAttribute("y1", w.y1*600);
    line.setAttribute("x2", w.x2*1000); line.setAttribute("y2", w.y2*600);
    gWalls.appendChild(line);
    // handles
    const h1 = document.createElementNS("http://www.w3.org/2000/svg","circle");
    h1.setAttribute("cx", w.x1*1000); h1.setAttribute("cy", w.y1*600); h1.setAttribute("r", 8); h1.setAttribute("fill","#222");
    const h2 = document.createElementNS("http://www.w3.org/2000/svg","circle");
    h2.setAttribute("cx", w.x2*1000); h2.setAttribute("cy", w.y2*600); h2.setAttribute("r", 8); h2.setAttribute("fill","#222");
    gWalls.appendChild(h1); gWalls.appendChild(h2);
    let dragH=null, sx=0, sy=0, start={};
    function startDrag(h, which, e){
      dragH=which; sx=e.clientX; sy=e.clientY; start={x1:w.x1,y1:w.y1,x2:w.x2,y2:w.y2}; e.preventDefault();
    }
    h1.addEventListener("mousedown",(e)=>startDrag(h1,"h1",e));
    h2.addEventListener("mousedown",(e)=>startDrag(h2,"h2",e));
    window.addEventListener("mousemove",(e)=>{
      if (!dragH) return;
      const rect=map.getBoundingClientRect();
      let dx=(e.clientX-sx)/rect.width, dy=(e.clientY-sy)/rect.height;
      let nx = clamp01((dragH==="h1"?start.x1:start.x2)+dx);
      let ny = clamp01((dragH==="h1"?start.y1:start.y2)+dy);
      if (qs("#snap").checked){ nx = gridSnap(nx, 0.02); ny = gridSnap(ny, 0.02); }
      if (dragH==="h1"){ w.x1=nx; w.y1=ny; } else { w.x2=nx; w.y2=ny; }
      savePlan(plan); renderPlan();
    });
    window.addEventListener("mouseup",()=> dragH=null);
    // right-click delete wall
    line.addEventListener("contextmenu",(e)=>{ e.preventDefault(); if (confirm("Usunąć ścianę?")){ plan.walls = plan.walls.filter(x=>x!==w); savePlan(plan); renderPlan(); } });
  });
  // dots (lights) with color from state if available
  gDots.innerHTML = "";
  devs.forEach(d=>{
    if (typeof d.meta?.x !== "number" || typeof d.meta?.y !== "number") return;
    const cx = d.meta.x*1000, cy = d.meta.y*600;
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    const fill = d.state?.rgbHex || "#333333";
    c.setAttribute("cx",cx); c.setAttribute("cy",cy); c.setAttribute("r",12); c.setAttribute("fill",fill); c.setAttribute("opacity","0.95"); c.setAttribute("class","dot");
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x",cx+14); t.setAttribute("y",cy+4); t.setAttribute("font-size","12"); t.textContent = d.label || d.sku;
    g.appendChild(c); g.appendChild(t);
    g.addEventListener("click",(e)=> openMiniFor(d, e));
    // drag move dot
    let dragging=false, sx=0, sy=0, start={x:d.meta.x,y:d.meta.y};
    g.addEventListener("mousedown",(e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; start={x:d.meta.x,y:d.meta.y}; e.preventDefault(); });
    window.addEventListener("mousemove",(e)=>{
      if(!dragging) return;
      const rect=map.getBoundingClientRect();
      let dx=(e.clientX-sx)/rect.width, dy=(e.clientY-sy)/rect.height;
      let nx = clamp01(start.x+dx), ny = clamp01(start.y+dy);
      if (qs("#snap").checked){ nx = gridSnap(nx, 0.02); ny = gridSnap(ny, 0.02); }
      const all = loadDevices(); const idx = all.findIndex(x=>x.id===d.id);
      if (idx>=0){ all[idx].meta = Object.assign({}, all[idx].meta, { x:nx, y:ny }); saveDevices(all); }
      renderPlan();
    });
    window.addEventListener("mouseup",()=> dragging=false);
    gDots.appendChild(g);
  });
}

// Background image
qs("#bgFile").onchange = (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{ const plan = loadPlan(); plan.bg = String(reader.result); savePlan(plan); renderPlan(); };
  reader.readAsDataURL(f);
};
qs("#clearBg").onclick = ()=>{ const plan = loadPlan(); delete plan.bg; savePlan(plan); renderPlan(); };
qs("#addRoom").onclick = ()=>{ const plan = loadPlan(); plan.rooms = plan.rooms||[]; plan.rooms.push({ id: uuid(), x:.1,y:.1,w:.3,h:.25,label:"Pokój",color:"#f0f7ff" }); savePlan(plan); renderPlan(); };
qs("#addWall").onclick = ()=>{ const plan = loadPlan(); plan.walls = plan.walls||[]; plan.walls.push({ id: uuid(), x1:.2,y1:.2,x2:.6,y2:.2 }); savePlan(plan); renderPlan(); };
qs("#clearPlan").onclick = ()=>{ if (confirm("Wyczyścić plan (pokoje/ściany)?")){ const bg = loadPlan().bg; savePlan({ rooms:[], walls:[], bg }); renderPlan(); } };

// click to place position for current form device if exists
map.addEventListener("click",(e)=>{
  const rect = map.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;
  const form = formToObj();
  const list = loadDevices();
  const idx = list.findIndex(it=>it.device===form.device && it.sku===form.sku);
  if (idx>=0){
    list[idx].meta = Object.assign({}, list[idx].meta, { x, y });
    saveDevices(list); refreshSavedList(list[idx].id);
    qs("#posxy").value = `${x.toFixed(3)},${y.toFixed(3)}`;
  }
});

// ===== mini control =====
const mini = document.getElementById("mini");
let miniDev = null;
function openMiniFor(dev, event){
  miniDev = dev;
  document.getElementById("miniLabel").textContent = dev.label || dev.sku || "Urządzenie";
  document.getElementById("miniBri").value = Number(dev.state?.bri || 50);
  document.getElementById("miniBriVal").textContent = (dev.state?.bri || 50) + "%";
  const rect = map.getBoundingClientRect();
  const x = event.clientX - rect.left, y = event.clientY - rect.top;
  mini.style.left = (x + 10) + "px"; mini.style.top = (y + 10) + "px"; mini.style.display = "block";
}
document.getElementById("miniClose").onclick = ()=>{ mini.style.display="none"; miniDev=null; };
document.getElementById("miniBri").oninput = (e)=>{ document.getElementById("miniBriVal").textContent = e.target.value + "%"; };
document.getElementById("miniOn").onclick = async ()=>{ if (!miniDev) return; const rsp = await api("/api/power",{method:"POST",headers:{'Content-Type':'application/json'}, body: JSON.stringify({ device: miniDev.device, sku: miniDev.sku, on:true })}); show(qs("#raw"), rsp); };
document.getElementById("miniOff").onclick = async ()=>{ if (!miniDev) return; const rsp = await api("/api/power",{method:"POST",headers:{'Content-Type':'application/json'}, body: JSON.stringify({ device: miniDev.device, sku: miniDev.sku, on:false })}); show(qs("#raw"), rsp); };
document.getElementById("miniSetK").onclick = async ()=>{ if (!miniDev) return; const k = Number(document.getElementById("miniK").value); const rsp = await api("/api/colortemp",{method:"POST",headers:{'Content-Type':'application/json'}, body: JSON.stringify({ device: miniDev.device, sku: miniDev.sku, kelvin:k })}); show(qs("#raw"), rsp); };
document.getElementById("miniSetColor").onclick = async ()=>{
  if (!miniDev) return;
  const hex = document.getElementById("miniColor").value.replace("#","");
  const r = parseInt(hex.substring(0,2),16), g = parseInt(hex.substring(2,4),16), b = parseInt(hex.substring(4,6),16);
  const rsp = await api("/api/color",{method:"POST",headers:{'Content-Type':'application/json'}, body: JSON.stringify({ device: miniDev.device, sku: miniDev.sku, r, g, b })});
  show(qs("#raw"), rsp);
};

// ===== Auto-refresh state & colorized dots =====
let auto = false, timer = null;
qs("#toggleAuto").onclick = ()=>{
  auto = !auto; qs("#stateBadge").textContent = "auto-refresh: " + (auto?"on":"off");
  if (auto) startPolling(); else stopPolling();
};
function stopPolling(){ if (timer){ clearTimeout(timer); timer=null; } }
async function startPolling(){
  stopPolling();
  const list = loadDevices();
  for (const d of list){
    try{
      const r = await api(`/api/state?device=${encodeURIComponent(d.device)}&sku=${encodeURIComponent(d.sku)}`);
      const dev = r?.payload || {}; const caps = dev?.capabilities || [];
      const bri = caps.find(c=>c.instance==="brightness")?.state?.value;
      const rgb = caps.find(c=>c.instance==="colorRgb")?.state?.value;
      const power = caps.find(c=>c.type==="devices.capabilities.on_off")?.state?.value;
      // store simple state for rendering
      const hex = (typeof rgb === "number") ? ("#" + ("000000"+rgb.toString(16)).slice(-6)) : (power? "#ffdd55" : "#333333");
      d.state = { bri, rgb, power, rgbHex: hex };
    }catch(e){ /* ignore */ }
  }
  saveDevices(list); renderPlan();
  timer = setTimeout(startPolling, 3000);
}

// ===== Panel controls + state log =====
function deviceObj(){ return { device: qs("#device").value.trim(), sku: qs("#sku").value.trim() }; }
qs("#refresh").onclick = async ()=>{
  const {device, sku} = deviceObj(); if(!device || !sku) return alert("Podaj device i sku");
  const r = await api(`/api/state?device=${encodeURIComponent(device)}&sku=${encodeURIComponent(sku)}`);
  show(qs("#raw"), r);
};
qs("#on").onclick = async ()=>{ const rsp = await api("/api/power",{method:"POST",headers:{'Content-Type':'application/json'}, body: JSON.stringify({...deviceObj(), on:true})}); show(qs("#raw"), rsp); };
qs("#off").onclick = async ()=>{ const rsp = await api("/api/power",{method:"POST",headers:{'Content-Type':'application/json'}, body: JSON.stringify({...deviceObj(), on:false})}); show(qs("#raw"), rsp); };
qs("#brightness").oninput = e => qs("#bval").textContent = e.target.value;
qs("#setBrightness").onclick = async ()=>{ const rsp = await api("/api/brightness",{method:"POST",headers:{'Content-Type':'application/json'}, body: JSON.stringify({...deviceObj(), value: qs("#brightness").value})}); show(qs("#raw"), rsp); };
qs("#setColor").onclick = async ()=>{
  const hex = qs("#color").value.replace("#","");
  const r = parseInt(hex.substring(0,2),16), g = parseInt(hex.substring(2,4),16), b = parseInt(hex.substring(4,6),16);
  const rsp = await api("/api/color",{method:"POST",headers:{'Content-Type':'application/json'}, body: JSON.stringify({...deviceObj(), r, g, b})}); show(qs("#raw"), rsp);
};
qs("#setKelvin").onclick = async ()=>{ const kelvin = Number(qs("#kelvin").value); const rsp = await api("/api/colortemp",{method:"POST",headers:{'Content-Type':'application/json'}, body: JSON.stringify({...deviceObj(), kelvin})}); show(qs("#raw"), rsp); };

// ===== Project Export/Import =====
qs("#exportProject").onclick = ()=>{
  const data = JSON.stringify({ devices: loadDevices(), plan: loadPlan(), groups: loadGroups() }, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "govee-project.json"; a.click();
  URL.revokeObjectURL(url);
};
qs("#importProject").onchange = (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(String(reader.result||"{}"));
      if (obj.devices) saveDevices(obj.devices);
      if (obj.plan) savePlan(obj.plan);
      if (obj.groups) saveGroups(obj.groups);
      refreshSavedList(); renderPlan(); refreshGroups();
      alert("Zaimportowano projekt.");
    }catch(err){ alert("Błąd importu: "+err.message); }
  };
  reader.readAsText(f);
};

// init
(function init(){
  refreshSavedList();
  refreshGroups();
  renderPlan();
})();
</script>
</body>
</html>
