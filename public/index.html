
<!doctype html>
<html lang="pl">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Govee – Panel (Cloud API) v4.4</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;max-width:900px}
  .row{display:flex;gap:12px;align-items:center;margin:10px 0;flex-wrap:wrap}
  input[type="range"]{width:300px}
  fieldset{border:1px solid #ddd;padding:16px;border-radius:12px;margin-bottom:16px}
  legend{padding:0 6px;color:#555}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;cursor:pointer}
  .muted{color:#666}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 720px){ .grid{grid-template-columns:1fr} }
  pre{background:#f6f6f6;border:1px solid #e5e5e5;padding:10px;border-radius:8px;max-height:260px;overflow:auto}
</style>
<body>
  <h1>Govee – Panel (Cloud API) <small>v4.4</small></h1>
  <p class="muted">Odczyt stanu: <b>r.payload.capabilities</b> (wariant B). Sterowanie: powerSwitch, brightness, colorRgb (int), colorTemperatureK.</p>

  <fieldset>
    <legend>Parametry urządzenia</legend>
    <div class="row grid">
      <div>
        <label>ID urządzenia (device):</label><br/>
        <input id="device" placeholder="np. 6F:F6:..." />
      </div>
      <div>
        <label>SKU:</label><br/>
        <input id="sku" placeholder="np. H6004" />
      </div>
    </div>
    <div class="row">
      <button id="refresh">Odśwież stan</button>
      <span id="devinfo" class="muted"></span>
    </div>
    <pre id="raw"></pre>
  </fieldset>

  <fieldset>
    <legend>Sterowanie</legend>
    <div class="row">
      <button id="on">Włącz</button>
      <button id="off">Wyłącz</button>
      <span id="status"></span>
    </div>
    <div class="row">
      <input type="range" id="brightness" min="1" max="100" value="50"/>
      <span id="bval">50</span>%
      <button id="setBrightness">Ustaw jasność</button>
    </div>
    <div class="row">
      <input type="color" id="color" value="#ffffff"/>
      <button id="setColor">Ustaw kolor</button>
    </div>
    <div class="row">
      <input type="number" id="kelvin" value="3000" step="50" min="2700" max="6500"/>
      <button id="setKelvin">Ustaw CCT</button>
    </div>
  </fieldset>

<script>
const qs = (s)=>document.querySelector(s);
const api = (p, opt)=>fetch(p, opt).then(r=>r.json());
const deviceObj = ()=>({ device: qs("#device").value.trim(), sku: qs("#sku").value.trim() });
const show = (el, obj)=> el.textContent = JSON.stringify(obj, null, 2);

qs("#refresh").onclick = async ()=>{
  const {device, sku} = deviceObj();
  if(!device || !sku){ qs("#devinfo").textContent = "Podaj device i sku"; return; }
  const r = await api(`/api/state?device=${encodeURIComponent(device)}&sku=${encodeURIComponent(sku)}`);
  const dev = r?.payload || null;
  const caps = dev?.capabilities || [];
  const online = caps.find(c=>c.type==="devices.capabilities.online")?.state?.value;
  const power = caps.find(c=>c.type==="devices.capabilities.on_off")?.state?.value;
  const bri = caps.find(c=>c.instance==="brightness")?.state?.value;
  const rgb = caps.find(c=>c.instance==="colorRgb")?.state?.value;
  const cct = caps.find(c=>c.instance==="colorTemperatureK")?.state?.value;
  qs("#devinfo").textContent = r?.code === 200
    ? `online:${online} power:${power} bri:${bri} rgb:${rgb} cct:${cct}`
    : `Błąd: ${r?.code} ${r?.msg || r?.message || ""}`;
  show(qs("#raw"), r);
};

qs("#on").onclick = async ()=>{
  const rsp = await api("/api/power",{method:"POST",headers:{'Content-Type':'application/json'},
    body: JSON.stringify({...deviceObj(), on:true})});
  qs("#status").textContent = rsp?.msg ?? rsp?.code ?? "OK";
  show(qs("#raw"), rsp);
};
qs("#off").onclick = async ()=>{
  const rsp = await api("/api/power",{method:"POST",headers:{'Content-Type':'application/json'},
    body: JSON.stringify({...deviceObj(), on:false})});
  qs("#status").textContent = rsp?.msg ?? rsp?.code ?? "OK";
  show(qs("#raw"), rsp);
};

qs("#brightness").oninput = e => qs("#bval").textContent = e.target.value;
qs("#setBrightness").onclick = async ()=>{
  const rsp = await api("/api/brightness",{method:"POST",headers:{'Content-Type':'application/json'},
    body: JSON.stringify({...deviceObj(), value: qs("#brightness").value})});
  alert(rsp?.msg ?? rsp?.code ?? "OK");
  show(qs("#raw"), rsp);
};

qs("#setColor").onclick = async ()=>{
  const hex = qs("#color").value.replace("#","");
  const rR = parseInt(hex.substring(0,2),16);
  const gG = parseInt(hex.substring(2,4),16);
  const bB = parseInt(hex.substring(4,6),16);
  const rsp = await api("/api/color",{method:"POST",headers:{'Content-Type':'application/json'},
    body: JSON.stringify({...deviceObj(), r: rR, g: gG, b: bB})});
  alert(rsp?.msg ?? rsp?.code ?? "OK");
  show(qs("#raw"), rsp);
};

qs("#setKelvin").onclick = async ()=>{
  const kelvin = Number(qs("#kelvin").value);
  const rsp = await api("/api/colortemp",{method:"POST",headers:{'Content-Type':'application/json'},
    body: JSON.stringify({...deviceObj(), kelvin})});
  alert(rsp?.msg ?? rsp?.code ?? "OK");
  show(qs("#raw"), rsp);
};
</script>
</body>
</html>
